<%- include('../layout/layout', {
  content: `
<div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 py-12 px-4">
  <h1 class="text-4xl font-bold mb-4 text-gray-800">Programs</h1>
  <p class="text-lg text-gray-500 mb-8 text-center">Click on the program title to see more details</p>

  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full max-w-5xl">
    ${Prog.map(program => `
      <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-2xl transition">
        <a href="/ejs/pages/${program._id}" 
           class="text-2xl font-semibold text-gray-800 hover:text-blue-500 transition mb-2 block">
          ${program.name}
        </a>
        <p class="text-gray-600">${program.description || 'No description available'}</p>
        <div class="mt-4">
          <span class="text-sm font-semibold text-gray-500">Duration:</span> ${program.duration || '-'}<br>
          <span class="text-sm font-semibold text-gray-500">Price:</span> $${program.price || '-'}

          <!-- Admin delete button -->
          <div class="admin-only hidden">
            <button 
              onclick="deleteProgram('${program._id}')"
              class="mt-4 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    `).join('')}
  </div>

  <!-- Add Program Button (Admin only) -->
  <div class="admin-only hidden mt-8">
    <button 
      onclick="openModal()"
      class="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition"    >
      + Add a Program
    </button>
  </div>
  <!-- Add Program Modal - This will pop up when you click "Add a Program" -->
<div id="addProgramModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
    <!-- Modal Header -->
    <div class="flex justify-between items-center p-6 border-b">
      <h2 class="text-2xl font-bold text-gray-800">Add New Program</h2>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
        &times;
      </button>
    </div>
    
    <!-- Modal Form -->
    <form id="addProgramForm" class="p-6">
      <div class="space-y-4">
        <!-- Program Name -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Program Name *</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter program name"
          >
        </div>
        
        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea 
            id="description" 
            name="description" 
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Enter program description"
          ></textarea>
        </div>
        
        <!-- Duration -->
        <div>
          <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
          <input 
            type="text" 
            id="duration" 
            name="duration" 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="e.g., 3 months"
          >
        </div>
        
        <!-- Price -->
        <div>
          <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
          <input 
            type="number" 
            id="price" 
            name="price" 
            min="0"
            step="0.01"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="0.00"
          >
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="flex gap-3 mt-6 pt-4 border-t">
        <button 
          type="button" 
          onclick="closeModal()"
          class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition font-medium"
        >
          Cancel
        </button>
        <button 
          type="submit"
          class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition font-medium"
        >
          Add Program
        </button>
      </div>
    </form>
  </div>
</div>
</div>

<script>
  // Show admin controls if user is admin
  function checkAdminStatus() {
    try {
      const role = localStorage.getItem("role");

      if (role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.classList.remove("hidden"));
      }
    } catch (err) {
      console.error('Error parsing user data:', err);
    }
  }

  // Delete program function
  async function deleteProgram(programId) {
    if (!confirm("Are you sure you want to delete this program?")) return;

    try {
      const token = localStorage.getItem("token");
      const res = await fetch(\`/api/programs/\${programId}\`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": \`Bearer \${token}\`
        }
      });

      const data = await res.json();

      if (res.ok) {
        alert("Program deleted successfully!");
        location.reload();
      } else {
        alert(data.message || "Failed to delete program.");
      }
    } catch (err) {
      console.error("Error deleting program:", err);
      alert("Something went wrong.");
    }
  }

  // Redirect to Add Program page
  function addProgram() {
    window.location.href = '/ejs/pages/programs';
  }

  // Run admin check on load
  document.addEventListener('DOMContentLoaded', checkAdminStatus);

    // === MODAL FUNCTIONS ===

// Function to open the pop-up modal
function openModal() {
  document.getElementById('addProgramModal').classList.remove('hidden');
}

// Function to close the pop-up modal
function closeModal() {
  document.getElementById('addProgramModal').classList.add('hidden');
  resetForm();
}

// Function to clear the form when modal closes
function resetForm() {
  document.getElementById('addProgramForm').reset();
}

// Function to handle form submission
async function handleAddProgram(event) {
  event.preventDefault(); // Prevent page refresh
  
  const submitButton = event.target.querySelector('button[type="submit"]');
  const originalText = submitButton.textContent;
  
  try {
    // Show loading state
    submitButton.disabled = true;
    submitButton.textContent = 'Adding...';
    
    // Get form data
    const formData = new FormData(event.target);
    const programData = {
      name: formData.get('name'),
      description: formData.get('description'),
      duration: formData.get('duration'),
      price: parseFloat(formData.get('price')) || 0
    };
    
    // Get authentication token
    const token = localStorage.getItem('token');
    
    // Send data to server
    const response = await fetch('/api/programs', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': \`Bearer \${token}\`
      },
      body: JSON.stringify(programData)
    });
    
    const data = await response.json();
    
    if (response.ok) {
      alert('✅ Program added successfully!');
      closeModal();
      location.reload(); // Refresh page to show new program
    } else {
      throw new Error(data.message || 'Failed to add program');
    }
    
  } catch (error) {
    console.error('Error adding program:', error);
    alert('❌ ' + (error.message || 'Something went wrong. Please try again.'));
  } finally {
    // Reset button state
    submitButton.disabled = false;
    submitButton.textContent = originalText;
  }
}

// === SETUP EVENT LISTENERS ===

// This runs when the page loads
document.addEventListener('DOMContentLoaded', function() {
  // Check admin status (your existing function)
  checkAdminStatus();
  
  // Add form submit listener
  const form = document.getElementById('addProgramForm');
  if (form) {
    form.addEventListener('submit', handleAddProgram);
  }
  
  // Close modal when clicking outside
  const modal = document.getElementById('addProgramModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  }
});
</script>
`
}) %>